PYTHONWARNINGS="ignore:setup.py install is deprecated::setuptools.command.install"; export PYTHONWARNINGS
eval "$(direnv hook bash)"

# Only run bind commands in interactive shells
if [[ $- == *i* ]]; then
  bind '"\e[A":history-search-backward'
  bind '"\e[B":history-search-forward'
fi
export CODING_DIR="$HOME/Coding"
: "${NIX_DIR:=}" >/dev/null
if [ -z "${NIX_DIR:-}" ]; then
  export NIX_DIR="$HOME/nixos-config"
fi

update_all() {
  CURRENT_DIR=$(pwd)
  sudo -v || return 1
  cd "$NIX_DIR" || return 1
  echo -e "\nUpdating Nix flake..."
  if ! nix flake update; then
    echo "nix flake update failed"; cd "$CURRENT_DIR"; return 1
  fi

  echo -e "\nCopying Nix files to /etc/nixos/..."
  if ! sudo cp -r ./* /etc/nixos/; then
    echo "copy to /etc/nixos failed"; cd "$CURRENT_DIR"; return 1
  fi

  echo -e "\nRebuilding and switching NixOS..."
  if ! sudo nixos-rebuild switch --upgrade --show-trace; then
    echo "nixos-rebuild failed"; cd "$CURRENT_DIR"; return 1
  fi

  cd "$CURRENT_DIR" || return 1
  echo -e "\nCleaning up old nix generations..."

  sys_count=$(sudo nix-env --list-generations --profile /nix/var/nix/profiles/system 2>/dev/null | wc -l | tr -d ' ')
  if [ -z "$sys_count" ]; then sys_count=0; fi
  if [ "$sys_count" -gt 10 ]; then
    echo "Found $sys_count system generations; keeping latest 10"
    sudo nix-env --profile /nix/var/nix/profiles/system --delete-generations +10
  else
    echo "Only $sys_count system generations present; skipping system --delete-generations"
  fi

  user_count=$(nix-env --list-generations 2>/dev/null | wc -l | tr -d ' ')
  if [ -z "$user_count" ]; then user_count=0; fi
  if [ "$user_count" -gt 10 ]; then
    echo "Found $user_count user generations; keeping latest 10"
    nix-env --delete-generations +10
  else
    echo "Only $user_count user generations present; skipping user --delete-generations"
  fi

  read -r -p "Run full garbage collection now? This will remove unused store paths. [y/N] " answer
  case "$answer" in
    [yY][eE][sS]|[yY])
      sudo nix-collect-garbage -d
      ;;
    *)
      echo "Skipping nix-collect-garbage -d"
      ;;
  esac

  sudo /run/current-system/bin/switch-to-configuration boot || true
  echo -e "Update complete!"
}

alias update-all='update_all'

alias cdn='cd $NIX_DIR'
alias cdc='cd $CODING_DIR'
alias format-bank-excels='cd $CODING_DIR/python && python3 -m unified_bank_statement -i ~/Downloads/ --use-mappings --history --auto'

# Point SSH to GPG
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)

# Tell GPG which terminal window to use for the password popup
export GPG_TTY=$(tty)
gpg-connect-agent updatestartuptty /bye > /dev/null 2>&1

forgit() {
  for file in $(ls -d */); do cd $file; echo -e "----$file-----"; git $@; cd ..; done
}


recursive_replace()
{
  if [ $# -eq 2 ]; then
    command="grep -rl --exclude-dir='.git' $1 ./ | xargs sed -i 's/${1}/${2}/g'"
    echo -e "running: $command"
    eval $command
  elif [ $# -eq 3 ]; then
    command="grep -rl --exclude-dir='.git' $2 $1 | xargs sed -i 's/${2}/${3}/g'"
    echo -e "running: $command"
    eval $command
  else
    echo -e "Illegal number of arguments"
  fi
}

vpn-start-it() {
  sudo systemctl start surfshark-openvpn-it.service
}

vpn-stop-it() {
  sudo systemctl stop surfshark-openvpn-it.service
}

vpn-status-it() {
  sudo systemctl status surfshark-openvpn-it.service
}

vpn-start-us() {
  sudo systemctl start surfshark-openvpn-us.service
}

vpn-stop-us() {
  sudo systemctl stop surfshark-openvpn-us.service
}

vpn-status-us() {
  sudo systemctl status surfshark-openvpn-us.service
}
