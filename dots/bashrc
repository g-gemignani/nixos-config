PYTHONWARNINGS="ignore:setup.py install is deprecated::setuptools.command.install"; export PYTHONWARNINGS
eval "$(direnv hook bash)"

# Only run bind commands in interactive shells
if [[ $- == *i* ]]; then
  bind '"\e[A":history-search-backward'
  bind '"\e[B":history-search-forward'
fi
export CODING_DIR="$HOME/Coding"
: "${NIX_DIR:=}" >/dev/null
if [ -z "${NIX_DIR:-}" ]; then
  export NIX_DIR="$HOME/nixos-config"
fi

# Try to add private keys to the ssh agent. It's OK if no agent is
# present; we simply skip adding in that case.
if command -v ssh-add >/dev/null 2>&1; then
    if [ -n "$SSH_AUTH_SOCK" ] && [ -S "$SSH_AUTH_SOCK" ]; then
        for key in "$HOME/.ssh"/*; do
        [ -f "$key" ] || continue
        case "$key" in
            *.pub) continue ;;
        esac
        chmod 600 "$key" || true
        ssh-add "$key" 2>/dev/null || true
        done
    else
        # No socket available; skip adding keys.
        true
    fi
fi

alias update-all='(
  CURRENT_DIR=$(pwd) && \
  sudo -v && \
  cd "$NIX_DIR" && \
  echo -e "\nUpdating Nix flake..." && \
  nix flake update && \
  echo -e "\nCopying Nix files to /etc/nixos/..." && \
  sudo cp -r ./* /etc/nixos/ && \
  echo -e "\nRebuilding and switching NixOS..." && \
  sudo nixos-rebuild switch --upgrade --show-trace && \
  cd "$CURRENT_DIR" && \
  echo -e "\nCleaning up old nix generations..." && \
  nix-env --delete-generations 5 && \
  nix-collect-garbage -d && \
  echo -e "Update complete!"
)'

alias cdn='cd $NIX_DIR'
alias cdc='cd $CODING_DIR'

# Ensure gpg-agent is running and SSH_AUTH_SOCK is set appropriately
gpgconf --launch gpg-agent 2>/dev/null || true
# If SSH_AUTH_SOCK is already pointing to gpg-agent's ssh socket, skip ssh-add
if [[ -n "$SSH_AUTH_SOCK" ]] && [[ "$SSH_AUTH_SOCK" == *"S.gpg-agent.ssh"* ]]; then
  : # gpg-agent is providing SSH; do nothing
else
  # Try to locate gpg-agent's ssh socket and export it
  if [[ -n "$XDG_RUNTIME_DIR" ]] && [[ -S "$XDG_RUNTIME_DIR/gnupg/S.gpg-agent.ssh" ]]; then
    export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/gnupg/S.gpg-agent.ssh"
  fi
fi

forgit() {
  for file in $(ls -d */); do cd $file; echo -e "----$file-----"; git $@; cd ..; done
}


recursive_replace()
{
  if [ $# -eq 2 ]; then
    command="grep -rl --exclude-dir='.git' $1 ./ | xargs sed -i 's/${1}/${2}/g'"
    echo -e "running: $command"
    eval $command
  elif [ $# -eq 3 ]; then
    command="grep -rl --exclude-dir='.git' $2 $1 | xargs sed -i 's/${2}/${3}/g'"
    echo -e "running: $command"
    eval $command
  else
    echo -e "Illegal number of arguments"
  fi
}

vpn-start-it() {
  sudo systemctl start surfshark-openvpn-it.service
}

vpn-stop-it() {
  sudo systemctl stop surfshark-openvpn-it.service
}

vpn-status-it() {
  sudo systemctl status surfshark-openvpn-it.service
}

vpn-start-us() {
  sudo systemctl start surfshark-openvpn-us.service
}

vpn-stop-us() {
  sudo systemctl stop surfshark-openvpn-us.service
}

vpn-status-us() {
  sudo systemctl status surfshark-openvpn-us.service
}
